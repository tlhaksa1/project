# Stata Programming II Project

**Survival Analysis of Self-Reported Health: Non-parametric and Semi-parametric Kaplan-Meier (KM) Curves**

Tenzin Lhaksampa

May 16, 2024 

## Objective: To provide suvival analysis of self-reported health.

## HW 7
### 1. Non-Parametric KM Curve
	
```
cls

//7.1. data
global repo &quot;https://raw.githubusercontent.com/tlhaksa1/project/main/&quot;
global nhanes &quot;https://wwwn.cdc.gov/Nchs/Nhanes/&quot;

//2. code
do ${repo}followup.do
save followup, replace 
import sasxport5 &quot;${repo}DEMO.XPT&quot;, clear
merge 1:1 seqn using followup, nogen
save survey_followup, replace 

//3. parameters 
import sasxport5 &quot;${repo}HUQ.XPT&quot;, clear
tab huq010 
merge 1:1 seqn using survey_followup, nogen keep(matched)
rm followup.dta
rm survey_followup.dta
g years=permth_int/12
stset years, fail(mortstat)
replace huq010=. if huq010==9
label define huq 1 &quot;Excellent&quot; 2 &quot;Very Good&quot; 3 &quot;Good&quot; 4 &quot;Fair&quot; 5 &quot;Poor&quot;
label values huq010 huq 
levelsof huq010, local(numlevels)
local i=1
foreach l of numlist `numlevels' {
	local vallab: value label huq010 
	local catlab: lab `vallab' `l'
	global legend`i' = &quot;`catlab'&quot;
	local i= `i' + 1
}
save week7, replace 

sts graph, ///
by(huq010) ///
fail ///
per(100) ///
ylab(0(20)80 , ///
format(%2.0f) ///
) ///
xlab(0(5)20) ///
tmax(20) ///
ti(&quot;Self-Reported Health and Mortality&quot;) ///
legend( ///
order(5 4 3 2 1) ///
lab(1 &quot;$legend1&quot;) ///
lab(2 &quot;$legend2&quot;) ///
lab(3 &quot;$legend3&quot;) ///
lab(4 &quot;$legend4&quot;) ///
lab(5 &quot;$legend5&quot;) ///
ring(0) pos(11) ///
)


graph export nonpara.png, replace
'''

![](nonpara.png)


### 2. Semi-Parametric KM Curve

```
/* -- earlier code --*/
stcox i.huq010, basesurv(s0)
matrix define mat = r(table)
matrix list mat 
matrix mat = mat'
svmat mat
	
preserve 
keep mat*
drop if missing(mat1)
rename (mat1 mat2 mat3 mat4 mat5 mat6 mat7 mat8 mat9)(b se z p ll ul df crit eform)
g x=_n
replace b=log(b)
replace ll=log(ll)
replace ul=log(ul)
	
twoway (scatter b x) || ///
	(rcap ll ul x, ///
		yline(0, lcol(lime)) ///
		ylab( ///
			-2.08 &quot;0.125&quot; ///
			-1.39 &quot;0.25&quot; ///
			-.69 &quot;0.5&quot; ///
			0 &quot;1&quot;  ///
			.69 &quot;2&quot; ///
			1.39 &quot;4&quot; ///
			2.08 &quot;8&quot; ///
			2.78 &quot;16&quot;) ///
		legend(off)  ///
	xlab( ///
		1 &quot;$legend1&quot; ///
		2 &quot;$legend2&quot; ///
		3 &quot;$legend3&quot; ///
		4 &quot;$legend4&quot; ///
		5 &quot;$legend5&quot;) ///
	xti(&quot;Self-Reported Health&quot;) ///
		) 
graph export semipara_unadj.png, replace 
graph save semipara_unadj.gph, replace 
restore 
'''


![](semipara_unadj.png)

## 3. Inference 
```
hist ridageyr 
graph export nonpara.png, replace 
//replace ridageyr=ridageyr/10
capture drop s0 
stcox i.huq010 ridageyr riagendr diabetes hyperten, basesurv(s0)
return list
matrix define mat_adj=r(table)
matrix define mat_adj=mat_adj'
matrix list mat_adj
svmat mat_adj
keep mat_adj*
drop if missing(mat_adj1)
rename (mat_adj1 mat_adj2 mat_adj3 mat_adj4 mat_adj5 mat_adj6 mat_adj7 mat_adj8 mat_adj9)(b se z p ll ul df crit eform)
g x=_n
replace b=log(b)
replace ll=log(ll)
replace ul=log(ul)

twoway (scatter b x if inrange(x,1,5)) || ///
	(rcap ll ul x if inrange(x,1,5), ///
		yline(0, lcol(lime)) ///
		ylab( ///
			-2.08 "0.125" ///
			-1.39 "0.25" ///
			-.69 "0.5" ///
			0 "1"  ///
			.69 "2" ///
			1.39 "4" ///
			2.08 "8" ///
			2.78 "16") ///
		legend(off)  ///
	xlab( ///
		1 "$legend1" ///
		2 "$legend2" ///
		3 "$legend3" ///
		4 "$legend4" ///
		5 "$legend5") ///
	xti("Self-Reported Health") ///
				   ) 
graph export semipara_adj.png, replace 
graph save semipara_adj.gph, replace 
'''

![](semipara_adj.png)

## 4. Updates
```
// Adjusted semi-parametric km curve
graph combine semipara_unadj.gph semipara_adj.gph, ///
	ycommon ti("Hazard Ratio, 95%CI") 
graph export unadj_adj.png, replace 
'''

![](unadj_adj.png)
	
## 5. Extracting Parameters
cls 
use week7, clear
replace riagendr=riagendr-1
stcox i.huq010 ridageyr riagendr, basesurv(s0)
keep s0 _t _t0 _st _d 
save s0, replace 
ereturn list 
matrix beta = e(b)
matrix vcov = e(V)
matrix SV = ( ///
	0, ///
	1, ///
	0, ///
	0, ///
	0, ///
	40, ///
	1 ///
)
matrix SV_ref = ( ///
	0, ///
	1, ///
	0, ///
	0, ///
	0, ///
	60, ///
	1 ///
)
//absolute risk
matrix risk_score = SV * beta'
matrix list risk_score
di exp(risk_score[1,1])
matrix var_prediction = SV * vcov * vcov'
matrix se_prediction = sqrt(var_prediction[1,1])

matrix risk_score_ref = SV_ref * beta'
matrix list risk_score_ref
di exp(risk_score_ref[1,1])
matrix var_prediction_ref = SV_ref * vcov * vcov'
matrix se_prediction_ref = sqrt(var_prediction_ref[1,1])

local hr = exp(risk_score_ref[1,1])/exp(risk_score[1,1])
	di `hr'

//di "We conclude that `exp(risk_score[1,1])'"

//
g f0 = (1 - s0) * 100 
g f1_ = f0 * exp(risk_score[1,1])
line f1 _t , ///  
	sort connect(step step) ///
	legend(ring(0)) ///
	ylab(0(5)20) xlab(0(5)20) ///
	yti("") ///
	ti("Scenario, %", pos(11)) ///
	xti("Years") ///
	note("40yo male who self-describes as being in good health" ///
		,size(1.5) ///
	)
graph export scenario.png, replace 
''' 

